<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vendetech.mapper.SysUserMapper">

  <resultMap type="SysUser" id="SysUserResult">
    <id property="userId" column="user_id"/>
    <result property="userName" column="user_name"/>
    <result property="ddUserId" column="dd_user_id"/>
    <result property="nickName" column="nick_name"/>
    <result property="errorCount" column="error_count"/>
    <result property="userType" column="user_type"/>
    <result property="email" column="email"/>
    <result property="mobile" column="mobile"/>
    <result property="sex" column="sex"/>
    <result property="avatar" column="avatar"/>
    <result property="password" column="password"/>
    <result property="status" column="status"/>
    <result property="loginIp" column="login_ip"/>
    <result property="loginDate" column="login_date"/>
    <result property="createBy" column="create_by"/>
    <result property="createTime" column="create_time"/>
    <result property="updateBy" column="update_by"/>
    <result property="updateTime" column="update_time"/>
    <result property="remark" column="remark"/>
  </resultMap>

  <select id="selectUserList" parameterType="SysUser" resultMap="SysUserResult">
    select user_id, user_name, dd_user_id, nick_name, error_count, user_type, email, mobile, sex, avatar, password,
    status, login_ip, login_date, create_by, create_time, update_by, update_time, remark
    from sys_user u
    <if test="userName != null and userName != ''">
      AND u.user_name like concat('%', #{userName}, '%')
    </if>
    <if test="status != null and status != ''">
      AND u.status = #{status}
    </if>
    <if test="mobile != null and mobile != ''">
      AND u.mobile like concat('%', #{mobile}, '%')
    </if>
    <if test="beginTime != null and beginTime != ''"><!-- 开始时间检索 -->
      AND date_format(u.create_time,'%y%m%d') &gt;= date_format(#{beginTime},'%y%m%d')
    </if>
    <if test="endTime != null and endTime != ''"><!-- 结束时间检索 -->
      AND date_format(u.create_time,'%y%m%d') &lt;= date_format(#{endTime},'%y%m%d')
    </if>
  </select>

  <select id="getErrorCount" parameterType="String" resultType="int">
    select IFNULL(error_count, 0), COUNT(*)
    from sys_user u
    where user_name = #{username}
  </select>

  <update id="updateErrorCount" parameterType="java.util.HashMap">
    update sys_user set error_count = #{count}, update_time = now()
    where user_name = #{username}
  </update>

  <select id="getByUserName" parameterType="java.lang.String" resultType="java.util.HashMap">
    SELECT su.user_id, su.email, su.dd_user_id, su.nick_name, su.user_name, su.avatar
    FROM sys_user su
    where su.user_name = #{loginName}
  </select>

  <select id="selectByUserList" parameterType="String" resultType="java.util.HashMap">
    SELECT
    su.nick_name,
    su.user_id,
    su.email,
    su.user_name,
    su.create_time
    FROM sys_user su
    <where>
      su.`status` = 0
      <if test="keyword != null and keyword != ''">
        and (dt.department_name like concat('%', #{keyword}, '%')
        or su.nick_name like concat('%', #{keyword}, '%')
        or su.user_name like concat('%', #{keyword}, '%')
        )
      </if>
    </where>
    ORDER BY su.create_time DESC
  </select>

  <select id="selectUserListByKeyword" parameterType="String" resultType="java.util.HashMap">
    SELECT
    su.nick_name,
    su.user_id,
    su.email,
    su.user_name,
    su.create_time
    FROM
    sys_user su
    <where>
      su.`status` = 0
      <if test="keyword != null and keyword != ''">
        and ( su.nick_name like concat('%', #{keyword}, '%') or su.user_name like concat('%', #{keyword}, '%') )
      </if>
    </where>
    ORDER BY su.create_time DESC
  </select>

  <select id="selectByUserName" parameterType="java.lang.String" resultMap="SysUserResult">
    select user_name, user_id
    from sys_user
    where user_name = #{userName}
  </select>
  <select id="selectDelFlag" parameterType="java.lang.String" resultMap="SysUserResult">
    select user_name
    from sys_user
    where user_name = #{userName}
  </select>
  <update id="updateDelFlag" parameterType="String">
    update sys_user
    <set>
      <if test="userName != null and userName != ''">user_name = #{userName},</if>
      <if test="nickName != null and nickName != ''">nick_name = #{nickName},</if>
      <if test="email != null and email != ''">email = #{email},</if>
      <if test="mobile != null and mobile != ''">mobile = #{mobile},</if>
      <if test="sex != null and sex != ''">sex = #{sex},</if>
      <if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
      <if test="password != null and password != ''">password = #{password},</if>
      <if test="status != null and status != ''">status = #{status},</if>
      <if test="loginIp != null and loginIp != ''">login_ip = #{loginIp},</if>
      <if test="loginDate != null">login_date = #{loginDate},</if>
      <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
      <if test="remark != null">remark = #{remark},</if>
      update_time = sysdate()
    </set>
    where user_id = #{userId}
  </update>

  <insert id="saveAccount" parameterType="SysUser" keyProperty="userId" useGeneratedKeys="true">
    insert into sys_user (user_id, dd_user_id, email, nick_name, user_name, password, create_time)
    values (#{userId}, #{ddUserId}, #{email}, #{nickName}, #{userName}, #{password}, sysdate())
  </insert>

  <update id="updateByStatus" parameterType="java.lang.Long">
    update sys_user
    set status = 1
    where user_id = #{userId}
  </update>

  <select id="selectUserByUserName" parameterType="String" resultMap="SysUserResult">
    select user_id,
           user_name,
           dd_user_id,
           nick_name,
           error_count,
           user_type,
           email,
           mobile,
           sex,
           avatar,
           password,
           status,
           login_ip,
           login_date,
           create_by,
           create_time,
           update_by,
           update_time,
           remark
    from sys_user u
    where u.user_name = #{userName}
  </select>

  <select id="selectUserById" parameterType="Long" resultMap="SysUserResult">
    select user_id,
           user_name,
           dd_user_id,
           nick_name,
           error_count,
           user_type,
           email,
           mobile,
           sex,
           avatar,
           password,
           status,
           login_ip,
           login_date,
           create_by,
           create_time,
           update_by,
           update_time,
           remark
    from sys_user u
    where u.user_id = #{userId}
  </select>

  <select id="checkUserNameUnique" parameterType="String" resultType="int">
    select count(1)
    from sys_user
    where user_name = #{userName}
  </select>

  <select id="checkPhoneUnique" parameterType="String" resultMap="SysUserResult">
    select user_id, mobile
    from sys_user
    where mobile = #{mobile}
  </select>

  <select id="checkEmailUnique" parameterType="String" resultMap="SysUserResult">
    select user_id, email
    from sys_user
    where email = #{email}
  </select>

  <insert id="insertUser" parameterType="SysUser" useGeneratedKeys="true" keyProperty="userId">
    insert into sys_user(
    <if test="userId != null and userId != 0">user_id,</if>
    <if test="userName != null and userName != ''">user_name,</if>
    <if test="nickName != null and nickName != ''">nick_name,</if>
    <if test="email != null and email != ''">email,</if>
    <if test="avatar != null and avatar != ''">avatar,</if>
    <if test="mobile != null and mobile != ''">mobile,</if>
    <if test="sex != null and sex != ''">sex,</if>
    <if test="password != null and password != ''">password,</if>
    <if test="status != null and status != ''">status,</if>
    <if test="createBy != null and createBy != ''">create_by,</if>
    <if test="remark != null and remark != ''">remark,</if>
    create_time
    )
    values
    (
    <if test="userId != null and userId != ''">#{userId},</if>
    <if test="userName != null and userName != ''">#{userName},</if>
    <if test="nickName != null and nickName != ''">#{nickName},</if>
    <if test="email != null and email != ''">#{email},</if>
    <if test="avatar != null and avatar != ''">#{avatar},</if>
    <if test="mobile != null and mobile != ''">#{mobile},</if>
    <if test="sex != null and sex != ''">#{sex},</if>
    <if test="password != null and password != ''">#{password},</if>
    <if test="status != null and status != ''">#{status},</if>
    <if test="createBy != null and createBy != ''">#{createBy},</if>
    <if test="remark != null and remark != ''">#{remark},</if>
    sysdate()
    )
  </insert>

  <update id="updateUser" parameterType="SysUser">
    update sys_user
    <set>
      <if test="userName != null and userName != ''">user_name = #{userName},</if>
      <if test="nickName != null and nickName != ''">nick_name = #{nickName},</if>
      <if test="email != null and email != ''">email = #{email},</if>
      <if test="mobile != null and mobile != ''">mobile = #{mobile},</if>
      <if test="sex != null and sex != ''">sex = #{sex},</if>
      <if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
      <if test="password != null and password != ''">`password` = #{password},</if>
      <if test="status != null and status != ''">`status` = #{status},</if>
      <if test="loginIp != null and loginIp != ''">login_ip = #{loginIp},</if>
      <if test="loginDate != null">login_date = #{loginDate},</if>
      <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
      <if test="remark != null">remark = #{remark},</if>
      update_time = sysdate()
    </set>
    where user_id = #{userId}
  </update>

  <update id="updateUserStatus" parameterType="SysUser">
    update sys_user
    set status = #{status}
    where user_id = #{userId}
  </update>

  <update id="updateUserAvatar" parameterType="SysUser">
    update sys_user
    set avatar = #{avatar}
    where user_name = #{userName}
  </update>

  <update id="resetUserPwd" parameterType="SysUser">
    update sys_user
    set password = #{password}
    where user_name = #{userName}
  </update>

  <delete id="deleteUserById" parameterType="Long">
    delete
    from sys_user
    where user_id = #{userId}
  </delete>

  <delete id="deleteUserByIds" parameterType="Long">
    update sys_user set status = '1' where user_id in
    <foreach collection="array" item="userId" open="(" separator="," close=")">
      #{userId}
    </foreach>
  </delete>

  <insert id="batchInsertSysUser" parameterType="com.vendetech.vo.SysUser">
    insert into sys_user
    ( dd_user_id,
      user_name,
      nick_name,
      mobile,
      email,
      avatar,
      sex,
      `status`,
      `password`,
      create_by,
      create_time )
    values
    <foreach collection="list" item="record" separator=",">
      ( #{record.ddUserId},
        #{record.userName},
        #{record.nickName},
        #{record.mobile},
        #{record.email},
        #{record.avatar},
        #{record.sex},
        #{record.status},
        #{record.password},
        #{record.createBy},
        #{record.createTime} )
    </foreach>
  </insert>

  <select id="selectByEmail" parameterType="java.lang.Long" resultType="SysUser">
    select email
    from sys_user
    where user_id = #{userId,jdbcType=BIGINT}
  </select>

  <select id="selectUserListForBatchInsert" resultMap="SysUserResult">
    select u.user_name, u.dd_user_id
    from sys_user u
  </select>

  <select id="resetUserErrorCount">
    update sys_user set error_count = 0, update_time = NOW()
    where error_count > 0 and (TIMESTAMPDIFF(MINUTE, update_time, NOW()) > 10)
  </select>

</mapper>